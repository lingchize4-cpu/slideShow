<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0">

<style>

  /* ===============================
   横画面専用レイアウト
   =============================== */
@media (orientation: landscape) {

    /* UI全体を少し余裕持たせる */
    #container {
        padding: 8px;
        box-sizing: border-box;
    }

    /* 画像番号 */
    #imageNumber {
        top: 12px;
        left: 12px;
        font-size: 18px;
    }

    /* タイマー表示 */
    #timerDisplay {
        top: 12px;
        left: 110px;
        font-size: 18px;
    }

    #timerInput {
        top: 12px;
        left: 110px;
        font-size: 16px;
    }

    #timerSetBtn {
        top: 12px;
        left: 190px;
    }

    /* モード・FINISH・BPM */
    #modeBtn {
        top: 12px;
        right: 340px;
        font-size: 15px;
    }

    #finishBtn {
        top: 12px;
        right: 250px;
        font-size: 15px;
    }

    #bpmInput {
        top: 12px;
        right: 170px;
        width: 70px;
        font-size: 15px;
    }

    /* STOP */
    #pauseBtn {
        top: 12px;
        right: 12px;
        font-size: 15px;
    }

    /* 音量UI → 右側中央 */
    #volumeArea {
        top: 50%;
        right: 14px;
        transform: translateY(-50%);
        background: rgba(0,0,0,0.35);
        padding: 8px;
        border-radius: 8px;
        font-size: 13px;
    }

    #volumeArea input {
        width: 160px;
    }

    /* BGMシークは少し上に */
    #bgmSeekArea {
        bottom: 16px;
        width: 85%;
    }
}

html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    background: black;
}

#container {
    position: relative;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
}

#slideshow {
    width: 100%;
    height: 100%;
    /*object-fit: cover; /* 画面最大 */
    object-fit: contain; /* 画面内に収まる */
    transform-origin: center;
}

/* UI */
#imageNumber {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 30;
    color: white;
    font-size: 16px;
    background: rgba(0,0,0,0.5);
    padding: 4px 8px;
    border-radius: 6px;
}

#pauseBtn, #modeBtn, #finishBtn {
    position: absolute;
    top: 10px;
    z-index: 30;
    padding: 6px 10px;
    border-radius: 8px;
    border: none;
    color: white;
    font-size: 14px;
}

#modeBtn { right: 250px; background: rgba(0,0,0,0.6); }
#finishBtn { right: 170px; background: rgba(140,0,140,0.7); }
#pauseBtn { right: 10px; background: rgba(0,0,0,0.6); }

#bpmInput {
    position: absolute;
    top: 10px;
    right: 95px;
    width: 60px;
    z-index: 30;
    border-radius: 6px;
    border: none;
    padding: 4px;
    text-align: center;
    font-size: 14px;
}

/* ===== 音量UI ===== */
#volumeArea {
    position: absolute;
    top: 48px;
    right: 10px;
    z-index: 30;
    color: white;
    font-size: 12px;
}

#volumeArea input {
    width: 140px;
}

/* ===== BGMシーク ===== */
#bgmSeekArea {
    position: absolute;
    bottom: 12px;
    left: 50%;
    transform: translateX(-50%);
    width: 80%;
    z-index: 30;
    color: white;
    font-size: 12px;
}

#bgmSeek {
    width: 100%;
}

/* ===== 額縁風 ピンクエフェクト ===== */
.corner {
    position: absolute;
    width: 40vmin;
    height: 40vmin;
    opacity: 0;
    pointer-events: none;
    z-index: 20;
}

/* 左上 */
.top-left {
    top: 0;
    left: 0;
    background: linear-gradient(135deg,
        rgba(255,120,170,0.45),
        rgba(255,120,170,0.15),
        rgba(255,120,170,0)
    );
    clip-path: polygon(0 0, 100% 0, 0 100%);
}

/* 右上 */
.top-right {
    top: 0;
    right: 0;
    background: linear-gradient(225deg,
        rgba(255,120,170,0.45),
        rgba(255,120,170,0.15),
        rgba(255,120,170,0)
    );
    clip-path: polygon(100% 0, 0 0, 100% 100%);
}

/* 左下 */
.bottom-left {
    bottom: 0;
    left: 0;
    background: linear-gradient(45deg,
        rgba(255,120,170,0.45),
        rgba(255,120,170,0.15),
        rgba(255,120,170,0)
    );
    clip-path: polygon(0 100%, 0 0, 100% 100%);
}

/* 右下 */
.bottom-right {
    bottom: 0;
    right: 0;
    background: linear-gradient(315deg,
        rgba(255,120,170,0.45),
        rgba(255,120,170,0.15),
        rgba(255,120,170,0)
    );
    clip-path: polygon(100% 100%, 0 100%, 100% 0);
}

/* 拍で光る */
@keyframes framePulse {
    0% { opacity: 0; }
    20% { opacity: 1; }
    100% { opacity: 0; }
}
.pulse {
    animation: framePulse 0.45s ease-out;
}

@keyframes beatMove {
    0% { transform: scale(1); }
    30% {
        transform: scale(var(--zoom))
        translate(var(--x), var(--y))
        rotate(var(--r));
    }
    100% { transform: scale(1); }
}
.beat { animation: beatMove 0.45s ease-out; }
</style>
</head>
<body>
    
        <div id="phaseSettings" style="margin-top:10px; padding:10px; background:#111; color:white; font-size:12px;">
            <h4>PHASE SETTINGS</h4>
            Base Min BPM:
            <input type="number" id="setBaseMin" value="10"><br>

            Phase Step:
            <input type="number" id="setPhaseStep" value="10"><br>

            Phase Duration (sec):
            <input type="number" id="setPhaseDuration" value="60"><br>

            Burst Min BPM:
            <input type="number" id="setBurstMin" value="60"><br>

            Burst Max BPM:
            <input type="number" id="setBurstMax" value="120"><br>

            Burst Duration (sec):
            <input type="number" id="setBurstDuration" value="10"><br>

            <button id="applySettingsBtn">APPLY</button>
        </div>
<div id="container">
    <img id="slideshow">
    <div id="controlUI">
        <div id="imageNumber"></div>
        <button id="modeBtn">RANDOM</button>
        <button id="finishBtn">FINISH</button>
        <input id="bpmInput" type="number">
        <button id="pauseBtn">⏸ STOP</button>
        <button id="restBtn">REST</button>
        <button id="restoreBtn" disabled>BACK</button>

        <!-- タイマー表示 -->
        <div id="timerDisplay"
            style="position:absolute; top:10px; left:120px; z-index:30;
                    color:white; background:rgba(0,0,0,0.5);
                    padding:4px 8px; border-radius:6px;">
            10:00
        </div>

      <!-- タイマー設定 -->
        <input id="timerInput" type="number" min="1"
                style="position:absolute; top:10px; left:190px; width:60px;
                  z-index:30; display:none;">

        <button id="timerSetBtn"
                style="position:absolute; top:10px; left:260px; z-index:30;
                    border:none; border-radius:8px;
                    background:rgba(0,0,0,0.6); color:white;
                    padding:6px 10px;">
            TIMER
        </button>

        <button id="videoBtn"
            style="position:absolute; top:10px; right:330px; z-index:30;
                    border:none; border-radius:8px;
                    background:rgba(0,0,0,0.6); color:white;
                    padding:6px 10px;">
            VIDEO
        </button>

        <button id="phaseUpBtn"
            style="position:absolute; top:50px; right:330px; z-index:30;
                    border:none; border-radius:8px;
                    background:rgba(0,120,255,0.7); color:white;
                    padding:6px 10px;">
            PHASE +
        </button>

        <button id="phaseDownBtn"
            style="position:absolute; top:90px; right:330px; z-index:30;
                    border:none; border-radius:8px;
                    background:rgba(255,120,0,0.7); color:white;
                    padding:6px 10px;">
            PHASE -
        </button>

        <div id="phaseCounter"
                style="position:absolute; top:130px; right:330px; z-index:30;
                color:white; background:rgba(0,0,0,0.6);
                padding:6px 12px; border-radius:8px;
                font-size:18px; text-align:center;">
        0
        </div>

      <!-- カウンター操作 -->
        <button id="countUpBtn"
            style="position:absolute; top:180px; right:330px; z-index:30;
                    border:none; border-radius:8px;
                    background:rgba(0,180,120,0.8); color:white;
                    padding:6px 10px;">
            COUNT +
        </button>

        <button id="countDownBtn"
            style="position:absolute; top:220px; right:330px; z-index:30;
                    border:none; border-radius:8px;
                    background:rgba(180,60,60,0.8); color:white;
                    padding:6px 10px;">
            COUNT -
        </button>

        <button id="countApplyBtn"
            style="position:absolute; top:260px; right:330px; z-index:30;
                    border:none; border-radius:8px;
                    background:rgba(255,200,0,0.85); color:black;
                    padding:6px 10px;">
            APPLY
        </button>
        <!-- 音量 -->
        <div id="volumeArea">
            BGM<br>
            <input id="bgmVolume" type="range" min="0" max="1" step="0.01" value="0.5"><br>
            BPM<br>
            <input id="bpmVolume" type="range" min="0" max="1" step="0.01" value="0.5">
        </div>

        <!-- BGMシーク -->
        <div id="bgmSeekArea">
            <input id="bgmSeek" type="range" min="0" max="100" value="0">
        </div>

        <div class="corner top-left"></div>
        <div class="corner top-right"></div>
        <div class="corner bottom-left"></div>
        <div class="corner bottom-right"></div>

        <iframe id="videoFrame"
            style="
                position:absolute;
                top:0; left:0;
                width:100%; height:100%;
                z-index:15;
                display:none;
                border:none;
                background:black;"
            allow="autoplay; encrypted-media"
            allowfullscreen>
        </iframe>
  </div>
</div>

<button id="uiToggleBtn"
    style="position:absolute; bottom:20px; right:20px;
           z-index:40;
           border:none; border-radius:10px;
           background:rgba(0,0,0,0.7);
           color:white; padding:10px 14px;">
    UI HIDE
</button>

<audio id="metronome" src="sound/metronome.mp3"></audio>
<audio id="bgmSound" src="sound/bgm.mp3" loop></audio>
<audio id="finishSound" src="sound/finish.mp3"></audio>

<script>
/* ===== 設定 ===== */
const imageCount = 183;
const imageFolder = "Image";
const minInterval = 3000;
const maxInterval = 5000;

/* ===== Editable Settings ===== */
let baseMinBPM = 10;
let phaseStep = 10;
let editablePhaseDuration = 60;
let burstMinBPM = 60;
let burstMaxBPM = 120;
let burstDuration = 10;
let isPaused = false;
let isRandomMode = true;
let isFinished = false;
let BPM = 30;

let imageTimer = null;
let metroTimer = null;
let bpmTimer = null;

let bgmVol = 0.5;
let bpmVol = 0.5;

let audioCtx = null;
let useDefaultBeep = false;

let isVideoMode = false;

let phase = 1;
let phaseTimer = null;
let phaseDuration = editablePhaseDuration * 1000;

let phaseCount = 0;

let isUIVisible = true;

let isRestMode = false;
let savedPhase = null;

/* ===== Timer ===== */
let timerSeconds = 600;
let timerInterval = null;
let isTimerSetting = false;

/* ===== DOM ===== */
const slideshow = document.getElementById("slideshow");
const imageNumber = document.getElementById("imageNumber");
const pauseBtn = document.getElementById("pauseBtn");
const modeBtn = document.getElementById("modeBtn");
const finishBtn = document.getElementById("finishBtn");
const bpmInput = document.getElementById("bpmInput");
const bgmVolume = document.getElementById("bgmVolume");
const bpmVolume = document.getElementById("bpmVolume");
const bgmSeek = document.getElementById("bgmSeek");
const metronome = document.getElementById("metronome");
const bgmSound = document.getElementById("bgmSound");
const finishSound = document.getElementById("finishSound");
const corners = document.querySelectorAll(".corner");
const timerDisplay = document.getElementById("timerDisplay");
const timerInput = document.getElementById("timerInput");
const timerSetBtn = document.getElementById("timerSetBtn");
const videoBtn = document.getElementById("videoBtn");
const videoFrame = document.getElementById("videoFrame");
const phaseUpBtn = document.getElementById("phaseUpBtn");
const phaseDownBtn = document.getElementById("phaseDownBtn");
const phaseCounter = document.getElementById("phaseCounter");
const countUpBtn = document.getElementById("countUpBtn");
const countDownBtn = document.getElementById("countDownBtn");
const countApplyBtn = document.getElementById("countApplyBtn");
const controlUI = document.getElementById("controlUI");
const uiToggleBtn = document.getElementById("uiToggleBtn");
const restBtn = document.getElementById("restBtn");
const restoreBtn = document.getElementById("restoreBtn");
const setBaseMin = document.getElementById("setBaseMin");
const setPhaseStep = document.getElementById("setPhaseStep");
const setPhaseDuration = document.getElementById("setPhaseDuration");
const setBurstMin = document.getElementById("setBurstMin");
const setBurstMax = document.getElementById("setBurstMax");
const setBurstDuration = document.getElementById("setBurstDuration");
const applySettingsBtn = document.getElementById("applySettingsBtn");

const rand = (a,b)=>Math.random()*(b-a)+a;

bgmVolume.oninput = ()=>{
    bgmVol = bgmVolume.value;
    bgmSound.volume = bgmVol;
    finishSound.volume = bgmVol;
};

bpmVolume.oninput = ()=>{
    bpmVol = bpmVolume.value;
    metronome.volume = bpmVol;
};
bgmSound.addEventListener("timeupdate", ()=>{
    if (!bgmSound.duration) return;
    bgmSeek.value = (bgmSound.currentTime / bgmSound.duration) * 100;
});

bgmSeek.oninput = ()=>{
    if (!bgmSound.duration) return;
    bgmSound.currentTime = (bgmSeek.value / 100) * bgmSound.duration;
};
function scheduleNextImage() {
    if (isPaused) return;
    imageTimer = setTimeout(showNextImage, rand(minInterval,maxInterval));
}

function showNextImage() {
    if (isPaused) return;
    const i = Math.floor(Math.random()*imageCount)+1;
    slideshow.src = `${imageFolder}/Image${i}.jpg`;
    imageNumber.textContent = i;
    scheduleNextImage();
}
function playDefaultBeep() {
    if (!audioCtx) audioCtx = new AudioContext();

    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();

    osc.type = "sine";
    osc.frequency.value = 60;

    gain.gain.setValueAtTime(bpmVol * 0.35, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.3);

    osc.connect(gain);
    gain.connect(audioCtx.destination);

    osc.start();
    osc.stop(audioCtx.currentTime + 0.32);
}
function triggerBeatEffect() {
    corners.forEach(c=>{
        c.classList.remove("pulse");
        void c.offsetWidth;
        c.classList.add("pulse");
    });

    const move = isFinished ? 8 : 4;
    const rot  = isFinished ? 1.2 : 0.6;
    const zoom = isFinished ? 1.06 : 1.03;

    slideshow.style.setProperty("--x", `${rand(-move,move)}px`);
    slideshow.style.setProperty("--y", `${rand(-move,move)}px`);
    slideshow.style.setProperty("--r", `${rand(-rot,rot)}deg`);
    slideshow.style.setProperty("--zoom", zoom);

    slideshow.classList.remove("beat");
    void slideshow.offsetWidth;
    slideshow.classList.add("beat");
}
function playBeat() {
    if (isPaused) return;
    triggerBeatEffect();

    if (useDefaultBeep) playDefaultBeep();
    else {
        metronome.currentTime = 0;
        metronome.volume = bpmVol;
        metronome.play().catch(()=>{
            useDefaultBeep = true;
            playDefaultBeep();
        });
    }
}
function restartMetro() {
    clearInterval(metroTimer);
    metroTimer = setInterval(playBeat, 60000 / BPM);
    bpmInput.value = BPM;
}
function startFixedBPM() {
    clearInterval(bpmTimer);
    BPM = Number(bpmInput.value) || BPM;
    restartMetro();
}

modeBtn.onclick = ()=>{
    if (isFinished) return;
    isRandomMode = !isRandomMode;
    modeBtn.textContent = isRandomMode ? "RANDOM" : "FIXED";
    bpmInput.disabled = isRandomMode;
    isRandomMode ? startPhaseSystem() : startFixedBPM();
};

pauseBtn.onclick = ()=>{
    if (!isPaused) {
        isPaused = true;
        clearTimeout(imageTimer);
        clearInterval(metroTimer);
        clearInterval(bpmTimer);
        bgmSound.pause();
        stopTimer();
        pauseBtn.textContent = "▶ PLAY";
    } else {
        isPaused = false;
        scheduleNextImage();
        isRandomMode ? startPhaseSystem() : startFixedBPM();
        startTimer();
        bgmSound.play().catch(()=>{});
        pauseBtn.textContent = "⏸ STOP";
    }
};

finishBtn.onclick = ()=>{
    isFinished = true;
    clearInterval(bpmTimer);
    isRandomMode = false;
    modeBtn.textContent = "FINISH";
    bpmInput.disabled = true;
    BPM = 240;
    restartMetro();
    bgmSound.pause();
    bgmSound.currentTime = 0;
    finishSound.currentTime = 0;
    finishSound.volume = bgmVol;
    finishSound.play().catch(()=>{});
};

showNextImage();
document.body.addEventListener("click", ()=>{
    bgmSound.volume = bgmVol;
    bgmSound.play().catch(()=>{});
    startPhaseSystem();
}, { once:true });

function updateTimerDisplay() {
    const m = String(Math.floor(timerSeconds / 60)).padStart(2, "0");
    const s = String(timerSeconds % 60).padStart(2, "0");
    timerDisplay.textContent = `${m}:${s}`;
}

function startTimer() {
    if (timerInterval || isTimerSetting) return;
    timerInterval = setInterval(() => {
        if (isPaused) return;
        timerSeconds--;
        updateTimerDisplay();
        if (timerSeconds <= 0) {
            stopTimer();
            finishBtn.onclick();
        }
    }, 1000);
}

function stopTimer() {
    clearInterval(timerInterval);
    timerInterval = null;
}

function resetTimer(sec) {
    stopTimer();
    timerSeconds = sec;
    updateTimerDisplay();
}

timerSetBtn.onclick = () => {
    isTimerSetting = !isTimerSetting;
    if (isTimerSetting) {
        stopTimer();
        timerInput.style.display = "inline";
        timerInput.value = Math.floor(timerSeconds / 60);
        timerDisplay.style.display = "none";
        timerSetBtn.textContent = "SET";
    } else {
        const min = Math.max(1, Number(timerInput.value));
        resetTimer(min * 60);
        timerInput.style.display = "none";
        timerDisplay.style.display = "inline";
        timerSetBtn.textContent = "TIMER";
        isTimerSetting = false;
        startTimer();
    }
};

videoBtn.onclick = () => {
      if (!isVideoMode) {
          isVideoMode = true;
          videoBtn.textContent = "SLIDE";
          videoFrame.src =`https://rule34video.com/embed/3860625`;
          videoFrame.style.display = "block";

      } else {
          isVideoMode = false;
          videoBtn.textContent = "VIDEO";
          videoFrame.src = "";
          videoFrame.style.display = "none";

          isPaused = false;
          scheduleNextImage();
          startTimer();
          isRandomMode ? startPhaseSystem() : startFixedBPM();
          bgmSound.play().catch(()=>{});
      }
  };

  function startPhaseSystem() {
    phase = 1;
    runPhase();
    phaseTimer = setInterval(() => {
        phase++;
        runPhase();
    }, phaseDuration);
}

function getPhaseBpmRange(phase) {
    const min = baseMinBPM + (phase - 1) * phaseStep;
    const max = min + 10;
    return { min, max };
}

function runPhase() {
    const { min, max } = getPhaseBpmRange(phase);
    BPM = Math.floor(rand(min, max));
    restartMetro();
    scheduleBurstBeat();
}

function scheduleBurstBeat() {
    const delay = rand(0, 50) * 1000;
    setTimeout(() => {
        startBurstBeat();
    }, delay);
}

function startBurstBeat() {
    const originalBPM = BPM;
    BPM = Math.floor(rand(burstMinBPM, burstMaxBPM + 1));
    restartMetro();
    setTimeout(() => {
        const { min, max } = getPhaseBpmRange(phase);
        BPM = Math.floor(rand(min, max));
        restartMetro();
    }, burstDuration * 1000);
}

function applyPhaseChange() {
    clearInterval(bpmTimer); // 念のため
    runPhase();
}

phaseUpBtn.onclick = () => {
    phase++;
    applyPhaseChange();
};

phaseDownBtn.onclick = () => {
    phase = Math.max(1, phase - 1);
    applyPhaseChange();
};

updatePhaseCounter();

function updatePhaseCounter() {
    phaseCounter.textContent = phaseCount;
}

countUpBtn.onclick = () => {
    phaseCount = Math.min(10, phaseCount + 1);
    updatePhaseCounter();
};

countDownBtn.onclick = () => {
    phaseCount = Math.max(0, phaseCount - 1);
    updatePhaseCounter();
};

countApplyBtn.onclick = () => {

    if (phaseCount === 0) {
        return;
    }
    phase = phaseCount;
    applyPhaseChange();
};

uiToggleBtn.onclick = () => {
    isUIVisible = !isUIVisible;
    controlUI.style.display = isUIVisible ? "block" : "none";
    uiToggleBtn.textContent = isUIVisible ? "UI HIDE" : "UI SHOW";
};

restBtn.onclick = () => {
    if (isRestMode) return;
    savedPhase = phase;
    phase = 1;
    isRestMode = true;
    restoreBtn.disabled = false;
};

function onPhaseMinuteEnd() {
    if (isRestMode)return;
    phase++;
}

restoreBtn.onclick = () => {
    if (!isRestMode || savedPhase === null) return;
    phase = savedPhase;
    isRestMode = false;
    savedPhase = null;
    restoreBtn.disabled = true;
};

applySettingsBtn.onclick = () => {

    baseMinBPM = Number(setBaseMin.value);
    phaseStep = Number(setPhaseStep.value);
    editablePhaseDuration = Number(setPhaseDuration.value);
    burstMinBPM = Number(setBurstMin.value);
    burstMaxBPM = Number(setBurstMax.value);
    burstDuration = Number(setBurstDuration.value);

    phaseDuration = editablePhaseDuration * 1000;

    if (isRandomMode) {
        clearInterval(phaseTimer);
        startPhaseSystem();
    }
}
</script>

</body>
</html>

